1. Agent may only touch code in the current stage.
2. Agent must add/adjust tests for the stage.
3. Agent must demonstrate: go test ./... green.
4. Only then is the next stage unlocked.
5. If we've completed the phase, move the Phase to the bottom of this document as "COMPLETED". Else, add notes of what was completed directly under the phase title in this document.


## **8) CLI v1: serve/import/export/projects (end-to-end over DB + importer)**

  

**Goal:** a usable tool without UI; validates integration.

  

**Work:**

- serve: starts server (can be stub responding “ok” for now).
    
- import: calls importer merge logic.
    
- projects list/create: uses project CRUD.
    
- export: can be stub until stage 10, but command wiring exists. 
    

  

**Tests:**

- CLI integration tests (run commands against temp DB).
    
- At minimum: create project → import scan → verify counts.
    

  

**Exit criteria:**

- CLI can create a project and import a scan without panics, and DB contains expected rows.
    

---

## **9) Web server skeleton + routing + minimal pages**

  
- Implemented chi-based web server with projects list/create/delete and shared templ layout.
- Added handler tests for GET /projects and POST /projects.
- Updated serve command to run the web server; tests still need module downloads to run.
- Manual smoke test passed: create/delete projects in browser.

**Goal:** establish the web layer with one trivial page and shared layout before building real screens.

  

**Work:**

- Implement internal/web/server.go, handlers.go with chi router. 
    
- Add one page: “Projects list” with create/delete.
    
- Decide templating approach (templ vs html/template) per Pre-flight. 
    

  

**Tests:**

- Handler tests via httptest:
    
    - GET /projects returns 200
        
    - POST /projects creates and redirects
        
    

  

**Exit criteria:**

- Web tests green.
    
- Manual smoke: run serve, manage projects in browser.
    

---

## **10) Core UI screens in order (each screen gated by handler tests)**

  

Build in this order to keep dependencies clean:

  

### **10.1 Project dashboard (counts only first)**

  
- Added dashboard handler and template at `/projects/{id}` with host counts, work status counts, and progress percentage.
- Added DB query helper for dashboard stats and handler test coverage.

**Work:**

- Query counts: total hosts, in-scope vs out-of-scope, counts by work_status. 
    
- Progress percentage definition (spec says done/total flagged). 
    

  

**Tests:** handler test asserts dashboard renders and includes expected counts given seeded DB.

  

**Exit criteria:** dashboard correct for seeded datasets.

  

### **10.2 Host list view (filter + sort)**

  
  
- Added host list view at `/projects/{id}/hosts` with filters (subnet/CIDR, work status, in-scope) and sort controls.
- Implemented aggregated host list query to avoid N+1 and added handler tests for filters/sort.

**Work:**

- Implement host list table: IP, hostname, port count, status summary, in-scope flag. 
    
- Filters: by subnet/CIDR, by work_status presence, by in-scope. 
    

  

**Tests:** query param tests (filter correctness).

  

**Exit criteria:** filters correct; no N+1 query explosions (basic benchmark optional).

  

### **10.3 Host detail view (ports table + inline status toggles)**

  
  
- Added host detail page with metadata, port table, status toggle forms, script output details, and notes for host/ports.
- Added handlers for status/notes updates with tests, and port state filtering (open/closed/filtered).
- Switched work status control to a dropdown and hid notes editing for non-open ports; centered filters for clarity.

**Work:**

- Show host metadata + editable notes. 
    
- Ports table includes: state, service/version, work_status toggle, per-port notes, script_output collapsible. 
    

  

**Tests:** toggle endpoint updates DB and returns expected fragment (if using htmx) or redirect.

  

**Exit criteria:** status change and note edits persist, script output is collapsed by default as spec says. 

  

### **10.4 Bulk operations UI**

  
  
- Added bulk operations UI and handlers: by host, by port number across project, and for filtered host list (open ports only).
- Added handler tests for each bulk op.

**Work:**

- Buttons/controls for the three bulk ops. 
    

  

**Tests:** endpoint tests for each bulk op.

  

**Exit criteria:** bulk ops work on real data without timeouts and are atomic (already tested earlier).

---

## **11) Export v1: JSON + CSV**

  
  
- Implemented JSON/CSV export with deterministic ordering, CLI/web wiring, and golden-file tests.

**Goal:** deliver exports from both CLI and UI.

  

**Work:**

- Implement internal/export/json.go and csv.go. 
    
- Flatten CSV: host info + port info. 
    
- Wire to:
    
    - CLI: nmap-tracker export --project ...
        
    - Web: “Export” buttons (optional)
        
    

  

**Tests:**

- Golden-file exports for seeded DB.
    
- CSV header stability test.
    

  

**Exit criteria:**

- Exports are correct and deterministic for same DB state.
    

---

## **12) Packaging + cross-platform builds**

  
  
- Updated build matrix in `Makefile` to produce cross-platform binaries in `dist/` with CGO disabled.
- Verified `make build-all` builds linux/amd64, linux/arm64, darwin/amd64, darwin/arm64, windows/amd64 binaries.

**Goal:** make the distribution story real.

  

**Work:**

- Confirm sqlite driver supports cross-compilation targets listed. 
    
- make build-all produces binaries for each target. 
    
- Embed templates/static assets into binary (if not already).
    

  

**Tests:**

- Build matrix script (even if local) that compiles all targets.
    
- Basic “binary runs and prints help” smoke for each.
    

  

**Exit criteria:**

- All targets compile successfully.
    

---

## **13) Hardening pass (only after feature-complete)**

  
  
- Wrapped importer merge in a DB transaction to avoid partial imports and improve speed; added rollback test.
- Added host list pagination to keep large lists responsive, with handler tests.

**Goal:** reduce long-term pain.

  

**Work:**

- DB performance checks for large scopes (indexes already listed). 
    
- Import speed: ensure transactions are used efficiently.
    
- UI responsiveness (pagination on host list if needed).
    

  

**Exit criteria:**

- Import of a “large enough” fixture completes within an acceptable time budget (you define it).
    
- No obvious UI timeouts on common queries.

---

## **8) CLI v1: serve/import/export/projects (end-to-end over DB + importer)** — COMPLETED

- Wired CLI subcommands: projects create/list, import (uses XML parser, scope matcher include-all, and merge logic), serve stub, export stub. Added flexible flag parsing for --db/--project.
- Integration tests exercise creating a project and importing `sampleNmap.xml`, asserting host/port rows in the DB.

---

## **9) Web server skeleton + routing + minimal pages** — COMPLETED

- Implemented chi-based web server with projects list/create/delete and shared templ layout.
- Added handler tests for GET /projects and POST /projects.
- Updated serve command to run the web server; tests run green after module download setup.
- Manual smoke test passed: create/delete projects in browser.

---

## **7) Workflow state machine + bulk ops (DB-level correctness)** — COMPLETED

- Added work_status update helpers and transactional bulk operations (by host, port number across project, and filtered sets) with tests for single updates, bulk correctness, protocol awareness, and failure handling.
- `go test`, `make test`, and `make build` remain green.

---

## **6) Import merge logic: observations → DB (additive, never remove, enrich updates)** — COMPLETED

- Implemented importer orchestration to create scan_import stats, upsert hosts with in_scope via scope matcher, and upsert ports additively while enriching service/version/product/extrainfo and preserving work_status/notes; last_seen updated per import.
- Tests cover additive behavior, enrichment, protocol-aware uniqueness, and scope change updating host.in_scope; all green alongside `go test`, `make test`, `make build`.

---

## **5) Import parsing: Nmap XML → normalized host/port observations** — COMPLETED

- Implemented XML parser producing host/port observations with service/version/product/extrainfo, state, OS guess, hostnames, and aggregated script output; supports TCP and UDP.
- Added fixtures including provided `sampleNmap.xml` and unit tests for the sample plus scripted/versioned host data; tests assert presence of services/states on all ports.

---

## **4) Scope matcher (CIDR, range, single IP, exclusions override includes)** — COMPLETED

- Implemented scope matcher supporting CIDR, ranges, and single IP definitions with exclusion precedence and configurable default when no includes are present.
- Added unit tests covering inclusion/exclusion precedence, IPv4/IPv6 ranges, defaults, and invalid inputs.

---

## **3) Data access layer (CRUD) for Project/Scope/Host/Port/ScanImport** — COMPLETED

- Added model structs and CRUD functions for projects, scopes, hosts (upsert), ports (protocol-aware upsert with last_seen handling), and scan_imports.
- Tests cover round-trips, uniqueness/upsert behavior, cascade-safe inserts, and protocol-specific port uniqueness; `go test ./...`, `make test`, and `make build` pass.

---

## **2) Database schema + migrations (no business logic yet)** — COMPLETED

- Added `internal/db/migrations/001_init.sql` with ERD tables, unique constraints, cascade FKs, and listed indexes.
- Implemented embedded migration runner + SQLite opener enabling WAL and foreign keys in `internal/db/db.go`.
- Added migration/WAL tests to verify schema, indexes, cascades, and concurrent opens.

---

## **1) Repo scaffold + CI-quality test harness** — COMPLETED

- Added module scaffold with placeholder commands, stub internal packages, Makefile with cache-safe env, and initial test helper to keep `go test` green.
- Verified `go test ./...`, `go build ./cmd/nmap-tracker`, `make test`, and `make build` succeed with the configured toolchain env.

---

## **0) Pre-flight: lock decisions and define “done”** — COMPLETED

- Added Implementation Notes to `agent_docs/SPEC.md` selecting `modernc.org/sqlite`, templ + htmx UI, work_status transitions only for open ports, and reaffirming additive imports with `last_seen` for staleness instead of deletion.
